<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toolshed AI - Vercel Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .overlay { position: absolute; top: 0; left: 0; pointer-events: none; }
        canvas { max-width: 100%; height: auto; }
        .shutter {
            animation: shutter-flash 0.3s ease-out;
        }
        @keyframes shutter-flash {
            0% { background: white; opacity: 0; }
            50% { background: white; opacity: 0.8; }
            100% { background: white; opacity: 0; }
        }
        .guide-box {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            position: absolute;
            top: 20%; left: 10%; right: 10%; bottom: 20%;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-green-400">üõ†Ô∏è Toolshed AI</h1>
            <p class="text-gray-400">Advanced Workstation Detection & Layout Simulation</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Controls -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Controls</h2>
                <div class="space-y-4">
                    <button id="snap" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Capture & AI Detect
                    </button>
                    
                    <div id="capture-hint" class="text-xs text-gray-400 text-center italic space-y-2">
                        <p>Tip: Point camera at your workbench/table</p>
                        <p class="text-blue-400">AI missed it? Drag on the photo to select</p>
                    </div>

                    <button id="clear" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Reset / Recapture
                    </button>

                    <div class="pt-4 border-t border-gray-700">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Simulate New Item</label>
                        <select id="itemType" class="w-full bg-gray-700 border-none rounded-lg p-3 text-white focus:ring-2 focus:ring-green-500">
                            <option>Shelf (Large)</option>
                            <option>Tool Rack (Wall)</option>
                            <option>Storage Bin (Box)</option>
                            <option>Cabinet (Floor)</option>
                        </select>
                    </div>
                </div>
                
                <div id="status" class="mt-6 p-3 rounded-lg bg-gray-900 border border-gray-700 text-sm text-yellow-400 animate-pulse hidden"></div>
            </div>

            <!-- Viewport -->
            <div class="md:col-span-2 relative bg-black rounded-2xl overflow-hidden shadow-2xl border-4 border-gray-800 cursor-crosshair group">
                <video id="video" class="w-full h-full object-cover" autoplay playsinline></video>
                <div id="guide" class="guide-box">Align workbench here</div>
                
                <canvas id="canvas" class="hidden"></canvas>
                <img id="result" class="hidden w-full h-full object-cover">
                
                <!-- Feedback Layers -->
                <div id="shutter-effect" class="absolute inset-0 pointer-events-none"></div>
                <div id="manual-overlay" class="absolute inset-0"></div>
            </div>
        </div>

        <div id="results-list" class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Detection results will appear here -->
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snap = document.getElementById('snap');
        const resultImg = document.getElementById('result');
        const status = document.getElementById('status');
        const resultsList = document.getElementById('results-list');
        const manualOverlay = document.getElementById('manual-overlay');
        const shutterEffect = document.getElementById('shutter-effect');
        const guide = document.getElementById('guide');
        let detections = [];

        // Access Camera
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                video.srcObject = stream;
                status.classList.add('hidden');
            } catch (err) {
                status.innerText = "Error: Camera access denied. Please enable camera permissions.";
                status.classList.remove('hidden');
            }
        }

        // Shutter Flash Effect
        function triggerShutter() {
            shutterEffect.classList.add('shutter');
            setTimeout(() => shutterEffect.classList.remove('shutter'), 300);
        }

        // Manual Selection Logic (Click and Drag)
        let isDragging = false;
        let startX, startY;
        let currentBox = null;

        manualOverlay.addEventListener('mousedown', (e) => {
            if (video.classList.contains('hidden') && !resultImg.classList.contains('hidden')) {
                isDragging = true;
                const rect = manualOverlay.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
                
                currentBox = document.createElement('div');
                currentBox.className = "absolute border-2 border-blue-400 bg-blue-400 bg-opacity-10 pointer-events-none rounded shadow-sm";
                currentBox.style.left = `${startX}px`;
                currentBox.style.top = `${startY}px`;
                manualOverlay.appendChild(currentBox);
            }
        });

        manualOverlay.addEventListener('mousemove', (e) => {
            if (isDragging && currentBox) {
                const rect = manualOverlay.getBoundingClientRect();
                const curX = e.clientX - rect.left;
                const curY = e.clientY - rect.top;
                
                const width = curX - startX;
                const height = curY - startY;
                
                currentBox.style.width = `${Math.abs(width)}px`;
                currentBox.style.height = `${Math.abs(height)}px`;
                currentBox.style.left = `${width > 0 ? startX : curX}px`;
                currentBox.style.top = `${height > 0 ? startY : curY}px`;
            }
        });

        window.addEventListener('mouseup', (e) => {
            if (isDragging && currentBox) {
                isDragging = false;
                const rect = manualOverlay.getBoundingClientRect();
                
                const imgX = parseInt(currentBox.style.left) / rect.width * resultImg.naturalWidth;
                const imgY = parseInt(currentBox.style.top) / rect.height * resultImg.naturalHeight;
                const imgW = parseInt(currentBox.style.width) / rect.width * resultImg.naturalWidth;
                const imgH = parseInt(currentBox.style.height) / rect.height * resultImg.naturalHeight;

                if (imgW > 20 && imgH > 20) {
                    detections.push({
                        x: imgX,
                        y: imgY,
                        w: imgW,
                        h: imgH,
                        type: 'Manual Selection'
                    });
                    updateDetectionsUI();
                } else {
                    manualOverlay.removeChild(currentBox);
                }
                currentBox = null;
            }
        });

        function updateDetectionsUI() {
            resultsList.innerHTML = '';
            if (detections.length === 0) {
                resultsList.innerHTML = '<p class="text-gray-500 text-sm italic col-span-full text-center">No workstations identified yet</p>';
                return;
            }
            detections.forEach((d, i) => {
                const div = document.createElement('div');
                div.className = "bg-gray-800 p-4 rounded-xl border border-green-500/30 hover:border-green-500 transition-colors shadow-lg";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs font-bold text-green-400 uppercase tracking-wider">Target #${i+1}</span>
                        <span class="text-[10px] text-gray-500 font-mono">${Math.round(d.w)}x${Math.round(d.h)}</span>
                    </div>
                    <div class="text-sm font-semibold text-white">${d.type}</div>
                `;
                resultsList.appendChild(div);
            });
        }

        snap.addEventListener('click', async () => {
            triggerShutter();
            status.innerText = "Analyzing environment...";
            status.classList.remove('hidden');
            
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.9);
            
            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });
                
                const data = await response.json();
                if (data.image) {
                    resultImg.src = data.image;
                    resultImg.classList.remove('hidden');
                    video.classList.add('hidden');
                    guide.classList.add('hidden');
                    detections = data.detections;
                    
                    if (detections.length === 0) {
                        status.innerText = "AI didn't find any surfaces. Try dragging a box manually!";
                    } else {
                        status.innerText = `Successfully detected ${detections.length} potential workstation area(s).`;
                    }
                    
                    updateDetectionsUI();
                }
            } catch (err) {
                status.innerText = "Connection error. Please check your network.";
            }
        });

        document.getElementById('clear').addEventListener('click', () => {
            resultImg.classList.add('hidden');
            video.classList.remove('hidden');
            guide.classList.remove('hidden');
            resultsList.innerHTML = '';
            manualOverlay.innerHTML = '';
            detections = [];
            status.classList.add('hidden');
            initCamera();
        });

        initCamera();
    </script>
</body>
</html>
